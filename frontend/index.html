<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerConnect - Peer Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .ios-card {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0046FF 0%, #73C8D2 100%);
        }
        
        .skill-tag {
            background: #FF9013;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .floating-action {
            background: #0046FF;
            box-shadow: 0 8px 32px rgba(0, 70, 255, 0.3);
        }
        
        .status-open { background: #FF9013; }
        .status-assigned { background: #0046FF; }
        .status-closed { background: #73C8D2; }
        
        .leaderboard-item {
            background: rgba(245,241,220,0.8);
            border-left: 4px solid;
        }
        
        .rank-1 { border-left-color: #FF9013; }
        .rank-2 { border-left-color: #73C8D2; }
        .rank-3 { border-left-color: #0046FF; }
        .rank-other { border-left-color: #73C8D2; }
        
        .tech-badge {
            background: #73C8D2;
            color: white;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: #10B981;
        }
        
        .toast.error {
            background: #EF4444;
        }

        .toast.info {
            background: #3B82F6;
        }
        
        .nav-btn.active {
            background: rgba(59, 130, 246, 0.1);
            color: rgb(37, 99, 235);
        }
        
        .request-item {
            transition: all 0.2s ease;
        }
        
        .request-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .skill-tag {
            transition: all 0.2s ease;
        }
        
        .skill-tag:hover {
            transform: scale(1.05);
        }
        
        .leaderboard-item {
            transition: all 0.2s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateX(4px);
        }
        
        .filter-btn.active {
            background: rgba(139, 92, 246, 0.1);
            color: rgb(126, 34, 206);
        }

        .rating-star {
            transition: all 0.2s ease;
        }

        .rating-star:hover {
            transform: scale(1.2);
        }

        .session-completed-btn {
            background: #10B981;
            color: white;
        }

        .session-completed-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .nav-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .ios-card {
                padding: 16px;
            }
            
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="toastContainer"></div>

    <nav class="ios-card rounded-none border-0 border-b border-white/20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center relative overflow-hidden" style="background: linear-gradient(135deg, #0046FF 0%, #73C8D2 50%, #FF9013 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8" cy="8" r="3.5" stroke="white" stroke-width="1.5" fill="none" opacity="0.9"/>
                            <circle cx="16" cy="16" r="3.5" stroke="white" stroke-width="1.5" fill="none" opacity="0.9"/>
                            <path d="M11 11L13 13" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                            <circle cx="8" cy="8" r="1" fill="white" opacity="0.9"/>
                            <circle cx="16" cy="16" r="1" fill="white" opacity="0.9"/>
                            <path d="M12 4L12.5 5.5L14 6L12.5 6.5L12 8L11.5 6.5L10 6L11.5 5.5Z" fill="white" opacity="0.7"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-800">PeerConnect</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showSection('dashboard')" class="nav-btn active text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg transition-colors">Dashboard</button>
                    <button onclick="showSection('requests')" class="nav-btn text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg transition-colors">Requests</button>
                    <button onclick="showSection('leaderboard')" class="nav-btn text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg transition-colors">Leaderboard</button>
                    <div class="relative">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center cursor-pointer" style="background: #73C8D2;" onclick="toggleUserMenu()">
                            <span class="text-white text-sm font-medium" id="userInitials">GU</span>
                        </div>
                        <div id="userMenu" class="absolute right-0 mt-2 w-48 ios-card rounded-xl shadow-lg hidden z-50">
                            <div class="py-1">
                                <button onclick="switchAccount()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Switch Account</button>
                                <button onclick="registerUser()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Register New User</button>
                                <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="dashboard" class="section">
            <div class="ios-card rounded-2xl p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2" id="welcomeMessage">Welcome to PeerConnect! üëã</h2>
                        <p class="text-gray-600" id="welcomeSubtitle">Please register or select an account to get started.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-blue-600" id="userRating">0</div>
                        <div class="text-sm text-gray-500">Your Rating</div>
                        <div class="flex text-orange-400 text-sm mt-1" id="ratingStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:max-w-md md:mx-auto gap-6 mb-8">
                <div class="ios-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Post a Help Request</h3>
                    <form onsubmit="postRequest(event)" class="space-y-4">
                        <input type="text" id="requestTitle" placeholder="What do you need help with?" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
                        <select id="requestSkill" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
                            <option value="">Select Skill</option>
                            <option value="Python">Python</option>
                            <option value="JavaScript">JavaScript</option>
                            <option value="React">React</option>
                            <option value="Node.js">Node.js</option>
                            <option value="SQL">SQL</option>
                            <option value="C++">C++</option>
                            <option value="Java">Java</option>
                            <option value="Machine Learning">Machine Learning</option>
                        </select>
                        <textarea id="requestDescription" placeholder="Describe your request in detail..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none h-24 resize-none" required></textarea>
                        <select id="preferredMode" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
                            <option value="">Preferred Mode</option>
                            <option value="Google Meet">Google Meet</option>
                            <option value="Zoom">Zoom</option>
                            <option value="In-Person">In-Person</option>
                            <option value="Phone Call">Phone Call</option>
                        </select>
                        <input type="url" id="meetingLink" placeholder="Meeting link (if online)" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        <button type="submit" class="w-full floating-action text-white py-3 rounded-xl font-medium hover:shadow-lg transition-all flex items-center justify-center">
                            <span id="postRequestText">Post Request</span>
                            <div id="postRequestLoader" class="loading hidden ml-2"></div>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="requests" class="section hidden">
            <div class="ios-card rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Help Requests</h3>
                    <div class="flex space-x-2">
                        <button onclick="filterRequests('all')" class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-purple-100 text-purple-700">All</button>
                        <button onclick="filterRequests('open')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Open</button>
                        <button onclick="filterRequests('assigned')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Assigned</button>
                        <button onclick="filterRequests('closed')" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Completed</button>
                    </div>
                </div>

                <div class="space-y-4" id="requestsList">
                    </div>
            </div>
        </div>

        <div id="leaderboard" class="section hidden">
            <div class="ios-card rounded-2xl p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Top Contributors</h3>
                <div class="space-y-3" id="leaderboardList">
                    </div>
            </div>
        </div>
    </div>

    <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="ios-card rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Rate Your Helper</h3>
            <p class="text-sm text-gray-600 mb-4" id="ratingTargetInfo">How was your session with the helper?</p>
            <div class="space-y-4">
                <div class="flex justify-center space-x-2 mb-4" id="ratingStarsInput">
                    <span class="text-2xl cursor-pointer rating-star" data-rating="1">‚òÜ</span>
                    <span class="text-2xl cursor-pointer rating-star" data-rating="2">‚òÜ</span>
                    <span class="text-2xl cursor-pointer rating-star" data-rating="3">‚òÜ</span>
                    <span class="text-2xl cursor-pointer rating-star" data-rating="4">‚òÜ</span>
                    <span class="text-2xl cursor-pointer rating-star" data-rating="5">‚òÜ</span>
                </div>
                <div id="ratingPreview" class="text-center text-sm text-gray-500 hidden">
                    <span id="selectedRatingText">0 stars</span>
                </div>
                <textarea id="ratingComment" placeholder="Share your feedback about the helper (optional)..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none h-24 resize-none"></textarea>
                <div class="flex space-x-3">
                    <button onclick="closeRatingModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button onclick="submitRating()" class="flex-1 py-3 floating-action text-white rounded-xl font-medium hover:shadow-lg transition-all flex items-center justify-center">
                        <span id="submitRatingText">Submit Rating</span>
                        <div id="submitRatingLoader" class="loading hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="remarksModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="ios-card rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Accept Request</h3>
            <p class="text-sm text-gray-600 mb-4">Add remarks for the requester (e.g., meeting time/place):</p>
            <div class="space-y-4">
                <textarea id="remarksComment" placeholder="I can help with this request..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none h-24 resize-none"></textarea>
                <div class="flex space-x-3">
                    <button onclick="closeRemarksModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button onclick="submitRemarksAndAccept()" class="flex-1 py-3 floating-action text-white rounded-xl font-medium hover:shadow-lg transition-all flex items-center justify-center">
                        <span id="submitRemarksText">Accept & Submit</span>
                        <div id="submitRemarksLoader" class="loading hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="userManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="ios-card rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" id="userManagementTitle">Switch Account</h3>
            <div class="space-y-4" id="userManagementContent">
                </div>
            <div class="flex space-x-3 mt-4">
                <button onclick="closeUserManagementModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                <button onclick="processUserManagement()" class="flex-1 py-3 floating-action text-white rounded-xl font-medium hover:shadow-lg transition-all" id="userManagementAction">Switch</button>
            </div>
        </div>
    </div>

    <div id="registrationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="ios-card rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Register New User</h3>
            <div class="space-y-4" id="registrationContent">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="regName" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Enter your full name" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="regEmail" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Enter your email" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <input type="text" id="regDept" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Enter your department" required>
                </div>
            </div>
            <div class="flex space-x-3 mt-4">
                <button onclick="closeRegistrationModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                <button onclick="registerNewUser()" class="flex-1 py-3 floating-action text-white rounded-xl font-medium hover:shadow-lg transition-all">Register</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://peer-connect-lqsy.onrender.com/api';
        
        // Current user data - Start with guest user
        let currentUser = {
            id: null,
            name: "Guest User",
            email: "guest@example.com",
            rating_avg: 0,
            dept: "Guest"
        };
        
        let currentRating = 0;
        let currentRequestToRate = null;
        let currentRequestToAccept = null; // Store request ID when accepting
        let userManagementMode = 'switch';
        let availableUsers = [];
        let assignmentsMap = new Map();
        let ratedRequests = new Set(); // Track which requests have been rated
        let requestStatusMap = new Map(); // Track request status locally

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ PeerConnect App Initialized');
            console.log('üì° API Base URL:', API_BASE_URL);
            console.log('üë§ Current User:', currentUser);
            
            initializeApp();
            initializeRatingStars();
        });

        // CORE APPLICATION FUNCTIONS

        async function initializeApp() {
            try {
                updateUserUI();
                
                // Load existing users but don't auto-login
                await loadExistingUsers();
                
                // Load initial data if we have a valid user
                if (currentUser.id && currentUser.email !== 'guest@example.com') {
                    await loadRequests();
                    await loadLeaderboard();
                } else {
                    // Show message to register first
                    document.getElementById('requestsList').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            Please register or select an account to view requests.
                        </div>
                    `;
                    document.getElementById('leaderboardList').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            Please register or select an account to view leaderboard.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to load application data');
            }
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // API FUNCTIONS

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            
            console.group(`üîó API Call: ${options.method || 'GET'} ${url}`);
            console.log('üì¶ Request Options:', options);
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                console.log('üì° Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    console.groupEnd();
                    
                    let errorMessage = `HTTP ${response.status}: `;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage += errorJson.message || errorJson.error || errorText;
                    } catch (e) {
                        errorMessage += errorText || 'Unknown error occurred';
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    console.log('‚úÖ API Success Response:', data);
                    console.groupEnd();
                    return data;
                } else {
                    console.log('‚úÖ API Success (No JSON content)');
                    console.groupEnd();
                    return { success: true, status: response.status };
                }
                
            } catch (error) {
                console.error('üí• API Call Failed:', error);
                console.groupEnd();
                throw error;
            }
        }

        // Student Management
        async function getAllStudents() {
            try {
                const students = await apiCall('/students');
                return Array.isArray(students) ? students : [];
            } catch (error) {
                console.error('Error fetching students:', error);
                return [];
            }
        }

        async function registerStudent(userData) {
            try {
                return await apiCall('/students', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: userData.name,
                        email: userData.email,
                        dept: userData.dept
                    })
                });
            } catch (error) {
                console.error('Registration error:', error);
                if (error.message.includes('duplicate key') || error.message.includes('23505')) {
                    throw new Error('Email already exists. Please use a different email.');
                }
                throw error;
            }
        }

        // Skills Management
        async function addStudentSkill(email, skillName, level) {
            try {
                return await apiCall('/student-skills', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        skill_name: skillName,
                        level: level
                    })
                });
            } catch (error) {
                console.error('Error adding skill:', error);
                throw error;
            }
        }

        // Requests Management
        async function createRequest(requestData) {
            try {
                console.group('üìù Creating New Request');
                
                const payload = {
                    requester_email: requestData.requester_email,
                    title: requestData.title,
                    description: requestData.description,
                    skill_name: requestData.skill_name,
                    preferred_mode: requestData.preferred_mode
                };
                
                if (requestData.meeting_link) {
                    payload.meeting_link = requestData.meeting_link;
                }
                
                console.log('Final request payload:', payload);
                const result = await apiCall('/requests', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                console.log('‚úÖ Request created successfully:', result);
                console.groupEnd();
                return result;
                
            } catch (error) {
                console.error('‚ùå Error creating request:', error);
                console.groupEnd();
                throw error;
            }
        }

        async function getAllRequests() {
            try {
                const requests = await apiCall('/requests'); 
                
                console.log('üìã Raw requests from API:', requests);
                
                const enhancedRequests = await Promise.all(
                    requests.map(async (request) => {
                        try {
                            // Get requester details
                            const requester = await getStudentById(request.requester_id);
                            request.requester_name = requester?.name || 'Unknown';
                            request.requester_email = requester?.email || 'Unknown';
                            
                            // Use local status if available, otherwise use server status
                            const localStatus = requestStatusMap.get(request.id);
                            if (localStatus) {
                                request.status = localStatus;
                            }
                            
                            return request;
                        } catch (error) {
                            console.error('Error enhancing request:', error);
                            return request;
                        }
                    })
                );
                
                return enhancedRequests;
            } catch (error) {
                console.error('Error fetching requests:', error);
                throw error;
            }
        }

        async function getStudentById(studentId) {
            try {
                return await apiCall(`/students/${studentId}`);
            } catch (error) {
                console.error(`Error fetching student ${studentId}:`, error);
                return null;
            }
        }
        
        // Fetch helper name + remarks for a given request (from assignments + students)
        async function fetchHelperDetails(requestId) {
            try {
                const res = await fetch(`${API_BASE}/assignments?request_id=${requestId}`);
                const data = await res.json();
                if (!data || data.length === 0) return null;

                const assignment = data[0];
                const helperRes = await fetch(`${API_BASE}/students/${assignment.helper_id}`);
                const helper = await helperRes.json();

                return {
                    helperName: helper.name,
                    remarks: assignment.remarks || "No remarks provided",
                    helperEmail: helper.email
                };
            } catch (err) {
                console.error("Error fetching helper details:", err);
                return null;
            }
        }


        // Assignment Management
        async function assignHelper(requestId, helperEmail, remarks = "I can help with this") {
            try {
                console.group('üë• Assigning Helper');
                
                const payload = {
                    request_id: requestId,
                    helper_email: helperEmail,
                    remarks: remarks
                };
                
                console.log('Assignment payload:', payload);
                const result = await apiCall('/assignments', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                console.log('‚úÖ Assignment created successfully:', result);
                console.groupEnd();
                return result;
                
            } catch (error) {
                console.error('‚ùå Error assigning helper:', error);
                console.groupEnd();
                throw error;
            }
        }

        // Ratings Management
        async function submitRatingToAPI(studentId, assignmentId, raterEmail, score, comment = "") {
            try {
                const payload = {
                    assignment_id: assignmentId,
                    rater_email: raterEmail,
                    score: score,
                    comment: comment
                };
                
                console.group('‚≠ê Submitting Rating');
                console.log('Rating payload:', payload);
                console.log('Student ID being rated:', studentId);
                
                // Try the correct endpoint structure
                const result = await apiCall(`/ratings`, {
                    method: 'POST',
                    body: JSON.stringify({
                        ...payload,
                        student_id: studentId  // Include student_id in the body instead of URL
                    })
                });
                
                console.log('‚úÖ Rating submitted successfully:', result);
                console.groupEnd();
                return result;
            } catch (error) {
                console.error('‚ùå Error submitting rating:', error);
                
                // Fallback: Try alternative endpoint if first one fails
                try {
                    console.log('üîÑ Trying alternative rating endpoint...');
                    const fallbackResult = await apiCall(`/ratings/${studentId}`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    console.log('‚úÖ Rating submitted via fallback endpoint:', fallbackResult);
                    console.groupEnd();
                    return fallbackResult;
                } catch (fallbackError) {
                    console.error('‚ùå Fallback rating submission also failed:', fallbackError);
                    console.groupEnd();
                    throw error; // Throw original error
                }
            }
        }

        async function getLeaderboard() {
            try {
                return await apiCall('/ratings/leaderboard');
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                return [];
            }
        }

        // USER REGISTRATION & MANAGEMENT

        async function loadExistingUsers() {
            try {
                availableUsers = await getAllStudents();
                console.log('Available users:', availableUsers);
                
                if (availableUsers.length === 0) {
                    showInfo('No existing users found. Please register a new user.');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showInfo('Please register a new user to get started.');
            }
        }

        function registerUser() {
            document.getElementById('userMenu').classList.add('hidden');
            document.getElementById('registrationModal').classList.remove('hidden');
            document.getElementById('registrationModal').classList.add('flex');
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            document.getElementById('registrationModal').classList.remove('flex');
        }

        async function registerNewUser() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const dept = document.getElementById('regDept').value;

            if (!name || !email || !dept) {
                showError('Please fill in all fields');
                return;
            }

            try {
                const userData = {
                    name: name,
                    email: email,
                    dept: dept
                };

                console.log('Registering user:', userData);
                
                const result = await registerStudent(userData);

                if (result) {
                    const newUser = {
                        id: result.id || result.student_id || Date.now(),
                        name: name,
                        email: email,
                        rating_avg: 0,
                        dept: dept
                    };
                    
                    // Add to available users
                    availableUsers.push(newUser);
                    
                    // Auto-login to the newly created user
                    currentUser = newUser;
                    
                    updateUserUI();
                    closeRegistrationModal();
                    showSuccess(`Successfully registered as ${name}!`);
                    
                    // Refresh data
                    await initializeApp();
                } else {
                    showError('Registration failed. Please try again.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message || 'Registration failed. Please try a different email.');
            }
        }

        function updateUserUI() {
            if (currentUser.id && currentUser.email !== 'guest@example.com') {
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.name}! üëã`;
                document.getElementById('welcomeSubtitle').textContent = 'Ready to help or learn something new today?';
                document.getElementById('userInitials').textContent = getInitials(currentUser.name);
                document.getElementById('userRating').textContent = currentUser.rating_avg;
                updateRatingStars(currentUser.rating_avg);
            } else {
                document.getElementById('welcomeMessage').textContent = `Welcome to PeerConnect! üëã`;
                document.getElementById('welcomeSubtitle').textContent = 'Please register or select an account to get started.';
                document.getElementById('userInitials').textContent = 'GU';
                document.getElementById('userRating').textContent = '0';
                updateRatingStars(0);
            }
        }

        // DATA LOADING 

        // Load and display requests
        async function loadRequests() {
            try {
                const requestsList = document.getElementById('requestsList');
                requestsList.innerHTML = '<div class="text-center py-4 text-gray-500">Loading requests...</div>';
                
                const requests = await getAllRequests();
                
                if (requests.length === 0) {
                    requestsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            No requests found. Be the first to post one!
                        </div>
                    `;
                    return;
                }
                
                requestsList.innerHTML = '';
                requests.forEach(request => {
                    const requestItem = createRequestItem(request);
                    requestsList.appendChild(requestItem);
                });
                
            } catch (error) {
                console.error('Error loading requests:', error);
                const requestsList = document.getElementById('requestsList');
                requestsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        Failed to load requests. Please try again.
                    </div>
                `;
            }
        }

        // Load and display leaderboard
        async function loadLeaderboard() {
            try {
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '<div class="text-center py-4 text-gray-500">Loading leaderboard...</div>';
                
                const leaderboard = await getLeaderboard();
                
                if (leaderboard.length === 0) {
                    leaderboardList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            No leaderboard data available.
                        </div>
                    `;
                    return;
                }
                
                leaderboardList.innerHTML = '';
                leaderboard.forEach((student, index) => {
                    const rankItem = createLeaderboardItem(student, index);
                    leaderboardList.appendChild(rankItem);
                });
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        Failed to load leaderboard.
                    </div>
                `;
            }
        }

        // CORRECTED UI COMPONENT CREATION 
        
        function createRequestItem(request) {
            const rawStatus = request.status || 'Open';
            const status = rawStatus.toLowerCase();

            const isMyRequest = request.requester_email === currentUser.email;
            const isAssignedToMe = request.helper_email === currentUser.email;

            const isRated = request.isRated;

            const requestItem = document.createElement('div');
            requestItem.className = `request-item ios-card rounded-xl p-4 border-l-4 ${
                status === 'open' ? 'border-orange-400' :
                status === 'assigned' ? 'border-blue-400' :
                'border-green-400'
            }`;
            requestItem.setAttribute('data-status', status);
            requestItem.setAttribute('data-request-id', request.id);

            let helperName = request.helper_name || '';
            let remarks = request.remarks || '';

            if (window.helperInfoMap && window.helperInfoMap.has(request.id)) {
                const info = window.helperInfoMap.get(request.id);
                helperName = info.name;
                remarks = info.remarks;
            }

            const skillBadgeHTML = ''; 

            let infoBoxHTML = `
                <div class="mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2">
                    <div class="flex items-center space-x-2 text-xs text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span>From: <strong>${escapeHtml(request.requester_name || request.requester_email || 'Unknown')}</strong></span>
                    </div>
            `;

            if (helperName) {
                infoBoxHTML += `
                    <div class="flex items-center space-x-2 text-xs text-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V10a2 2 0 012-2h4l-4-4V4a2 2 0 012-2h4a2 2 0 012 2v4z" /></svg>
                        <span>Helper: <strong>${escapeHtml(helperName)}</strong></span>
                    </div>
                `;
            }

            if (remarks) {
                infoBoxHTML += `
                    <div class="flex items-start space-x-2 text-xs text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                        <span class="italic"><strong>Remarks:</strong> ${escapeHtml(remarks)}</span>
                    </div>
                `;
            }

            infoBoxHTML += '</div>';


            requestItem.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold text-gray-800">${escapeHtml(request.title || 'Untitled Request')}</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            ${skillBadgeHTML}
                            ${isMyRequest ? '<span class="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Your Request</span>' : ''}
                            ${isAssignedToMe ? '<span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">You are helping</span>' : ''}
                            ${isRated ? '<span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Rated</span>' : ''}
                        </p>
                        
                        ${infoBoxHTML}

                        ${request.meeting_link ? `<p class="text-xs text-blue-500 mt-2"><a href="${request.meeting_link}" target="_blank" class="underline font-medium">Join Meeting</a></p>` : ''}
                    </div>
                    <span class="${
                        status === 'open' ? 'status-open' :
                        status === 'assigned' ? 'status-assigned' :
                        'status-closed'
                    } px-3 py-1 rounded-full text-xs font-medium text-white h-6">
                        ${request.status || 'Open'}
                    </span>
                </div>
                <p class="text-gray-700 text-sm mb-3">${escapeHtml(request.description || 'No description provided')}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">${formatDate(request.created_at)}</span>
                    ${getRequestActionButton(request, status, isMyRequest, isAssignedToMe, isRated)}
                </div>
            `;

            return requestItem;
        }

        function createLeaderboardItem(student, index) {
            const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
            const rankColor = index === 0 ? '#FF9013' : index === 1 ? '#73C8D2' : index === 2 ? '#0046FF' : '#73C8D2';
            
            const rankItem = document.createElement('div');
            rankItem.className = `leaderboard-item ${rankClass} rounded-xl p-4`;
            rankItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white" style="background: ${rankColor};">
                            ${index + 1}
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">${escapeHtml(student.name || 'Unknown User')}</h4>
                            <p class="text-sm text-gray-600">${escapeHtml(student.email || 'No email')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-800">${student.rating_avg || 0}</div>
                        <div class="text-xs text-gray-500">rating</div>
                    </div>
                </div>
            `;
            
            return rankItem;
        }

        // CORRECTED ACTION HANDLERS


        async function postRequest(event) {
            event.preventDefault();
            
            if (!currentUser.id || currentUser.email === 'guest@example.com') {
                showError('Please register or select an account first');
                registerUser();
                return;
            }
            
            const title = document.getElementById('requestTitle').value;
            const skill = document.getElementById('requestSkill').value;
            const description = document.getElementById('requestDescription').value;
            const preferredMode = document.getElementById('preferredMode').value;
            const meetingLink = document.getElementById('meetingLink').value;
            
            if (title && skill && description && preferredMode) {
                const postRequestBtn = document.getElementById('postRequestText');
                const postRequestLoader = document.getElementById('postRequestLoader');
                
                postRequestBtn.textContent = 'Posting...';
                postRequestLoader.classList.remove('hidden');
                
                try {
                    const requestData = {
                        requester_email: currentUser.email,
                        title: title,
                        description: description,
                        skill_name: skill,
                        preferred_mode: preferredMode
                    };
                    
                    if (meetingLink) {
                        requestData.meeting_link = meetingLink;
                    }
                    
                    const result = await createRequest(requestData);
                    
                    if (result) {
                        // Clear form
                        document.getElementById('requestTitle').value = '';
                        document.getElementById('requestSkill').value = '';
                        document.getElementById('requestDescription').value = '';
                        document.getElementById('preferredMode').value = '';
                        document.getElementById('meetingLink').value = '';
                        
                        showSuccess('Request posted successfully! üéâ');
                        
                        // Refresh requests and switch to requests section
                        await loadRequests();
                        showSection('requests');
                    } else {
                        showError('Failed to post request. Please try again.');
                    }
                } catch (error) {
                    console.error('Error posting request:', error);
                    showError('Failed to post request. Check console for details.');
                } finally {
                    postRequestBtn.textContent = 'Post Request';
                    postRequestLoader.classList.add('hidden');
                }
            } else {
                showError('Please fill in all required fields');
            }
        }

        async function acceptRequest(requestId) {
            if (!currentUser.id || currentUser.email === 'guest@example.com') {
                showError('Please register or select an account first');
                registerUser();
                return;
            }
            
            // Store the request ID globally
            currentRequestToAccept = requestId;

            // Set default remarks and show the modal
            document.getElementById('remarksComment').value = 'I can help with this request';
            document.getElementById('remarksModal').classList.remove('hidden');
            document.getElementById('remarksModal').classList.add('flex');
        }

        function closeRemarksModal() {
            document.getElementById('remarksModal').classList.add('hidden');
            document.getElementById('remarksModal').classList.remove('flex');
            currentRequestToAccept = null;
        }

        // function to handle submitting remarks and accepting the request
        async function submitRemarksAndAccept() {
            const requestId = currentRequestToAccept;
            if (!requestId) {
                showError('An error occurred. Please try again.');
                closeRemarksModal();
                return;
            }

            // Get remarks from the new text area
            const remarks = document.getElementById('remarksComment').value || "I can help with this request";
            
            const submitBtn = document.getElementById('submitRemarksText');
            const submitLoader = document.getElementById('submitRemarksLoader');
            
            submitBtn.textContent = 'Submitting...';
            submitLoader.classList.remove('hidden');

            try {
                console.log('Accepting request:', requestId, 'with remarks:', remarks);

                // Call backend to assign helper
                const result = await assignHelper(requestId, currentUser.email, remarks);

                if (result && result.assignment) {
                    console.log('Assignment created successfully:', result);

                    const assignmentId = result.assignment.id;
                    const helperId = result.helper_id;
                    const helperEmail = result.helper_email;

                    // Store assignment and helper info locally
                    assignmentsMap.set(requestId, assignmentId);

                    const helperInfo = {
                        id: helperId,
                        email: helperEmail,
                        name: currentUser.name,
                        remarks: remarks
                    };

                    if (!window.helperInfoMap) {
                        window.helperInfoMap = new Map();
                    }
                    window.helperInfoMap.set(requestId, helperInfo);

                    console.log(`üìù Stored assignment ${assignmentId} and helper info for request ${requestId}`);

                    // Update request status locally
                    requestStatusMap.set(requestId, 'assigned');

                    showSuccess(`Request accepted! üéâ You are now helping with this request.`);
                    
                    closeRemarksModal();
                    await loadRequests(); // refresh request list
                } else {
                    console.error('Assignment API returned:', result);
                    showError(result?.error?.message || 'Failed to accept request - no assignment created');
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                showError('Failed to accept request. Please try again.');
            } finally {
                submitBtn.textContent = 'Accept & Submit';
                submitLoader.classList.add('hidden');
                
                // Ensure modal is closed, even on failure
                if (document.getElementById('remarksModal').classList.contains('flex')) {
                     closeRemarksModal();
                }
            }
        }

        async function getAssignmentsForRequest(requestId) {
            try {
                return await apiCall(`/assignments/request/${requestId}`);
            } catch (error) {
                console.error(`Error fetching assignments for request ${requestId}:`, error);
                return [];
            }
        }

        async function requesterEndSessionAndRate(requestId, assignmentId) {
            if (!currentUser.id || currentUser.email === 'guest@example.com') {
                showError('Please register or select an account first');
                return;
            }

            if (!assignmentId) {
                showError('Cannot rate: Assignment ID is missing.');
                console.error('requesterEndSessionAndRate was called without an assignmentId.');
                return;
            }
            
            if (confirm('Are you sure you want to end this session and rate your helper?')) {
                try {
                    console.log('üìã Requester ending session and rating helper:', requestId);

                    currentRequestToRate = {
                        requestId: requestId,
                        assignmentId: assignmentId,
                        isRequesterRating: true 
                    };
                    
                    // Update status locally for immediate UI feedback
                    requestStatusMap.set(requestId, 'closed');
                    console.log(`‚úÖ Request ${requestId} status updated to closed locally`);
                    
                    console.log(`üéØ Requester starting rating process for assignment ${currentRequestToRate.assignmentId}`);
                    openRatingModal();
                    
                } catch (error) {
                    console.error('‚ùå Error ending session:', error);
                    showError('Failed to end session: ' + error.message);
                }
            }
        }


        // Update the submitRating function to handle helper lookup better
        async function submitRating() {
            if (currentRating > 0 && currentRequestToRate) {
                const submitRatingBtn = document.getElementById('submitRatingText');
                const submitRatingLoader = document.getElementById('submitRatingLoader');
                
                try {
                    // Show loading state
                    submitRatingBtn.textContent = 'Submitting...';
                    submitRatingLoader.classList.remove('hidden');   
                    console.log('‚≠ê Submitting rating:', currentRequestToRate);
                    
                    const requestId = currentRequestToRate.requestId;
                    const assignmentId = currentRequestToRate.assignmentId;
                    
                    // Get the request details
                    const requests = await getAllRequests();
                    const currentRequest = requests.find(req => req.id === requestId);
                    
                    if (!currentRequest) {
                        throw new Error('Could not find request details');
                    }
                    
                    // Find the helper - try multiple approaches
                    let helperId = null;
                    let helperEmail = null;
                    let helperName = null;
                    
                    // Approach 1: From the request itself
                    if (currentRequest.helper_id) {
                        helperId = currentRequest.helper_id;
                        helperEmail = currentRequest.helper_email;
                        helperName = currentRequest.helper_name;
                        console.log(`‚úÖ Found helper from request:`, { helperId, helperEmail, helperName });
                    }
                    // Approach 2: From our local helper info map
                    else if (window.helperInfoMap && window.helperInfoMap.has(requestId)) {
                        const helperInfo = window.helperInfoMap.get(requestId);
                        helperId = helperInfo.id;
                        helperEmail = helperInfo.email;
                        helperName = helperInfo.name;
                        console.log(`‚úÖ Found helper from local map:`, { helperId, helperEmail, helperName });
                    }
                    // Approach 3: From assignments API (This is a fallback)
                    else {
                        console.log(`üîÑ No helper in request, checking assignments API...`);
                        try {
                            const assignments = await getAssignmentsForRequest(requestId);
                            if (assignments && assignments.length > 0) {
                                const latestAssignment = assignments[0];
                                helperId = latestAssignment.helper_id;
                                if (helperId) {
                                    const helper = await getStudentById(helperId);
                                    helperEmail = helper?.email;
                                    helperName = helper?.name;
                                    console.log(`‚úÖ Found helper from assignments API:`, { helperId, helperEmail, helperName });
                                }
                            }
                        } catch (assignmentError) {
                            console.error(`‚ùå Error getting assignments:`, assignmentError);
                        }
                    }
                    
                    if (!helperId) {
                        // This might happen if the helper info isn't on the request yet
                        // Let's try to get it from the assignmentId we just passed
                        if (currentRequest.assignment_id) {
                             console.log(`üîÑ Final attempt: Finding helper via assignment_id ${currentRequest.assignment_id}`);
                        } else {
                            throw new Error('No helper assigned to this request. Please make sure the helper has accepted the request.');
                        }
                    }
                    
                    console.log(`üéØ Requester rating helper: ${helperName || helperEmail} (ID: ${helperId}) for assignment ${assignmentId}`);
                    
                    const result = await submitRatingToAPI(
                        helperId,
                        assignmentId,
                        currentUser.email,
                        currentRating,
                        document.getElementById('ratingComment').value || ''
                    );
                    
                    if (result && !result.error) {
                        assignmentsMap.delete(requestId);
                        ratedRequests.add(requestId);
                        showSuccess(`‚≠ê Rated ${helperName || helperEmail} with ${currentRating} stars!`);
                        await loadRequests();
                        await loadLeaderboard();
                        await refreshCurrentUser();
                    } else {
                        console.error("Rating API returned:", result);
                        showError(result?.error?.message || "Failed to submit rating");
                    }

                } catch (error) {
                    console.error('Error submitting rating:', error);
                    showError('Failed to submit rating: ' + error.message);
                } finally {
                    // Reset loading state - now these variables are in scope
                    submitRatingBtn.textContent = 'Submit Rating';
                    submitRatingLoader.classList.add('hidden');
                }
                
                closeRatingModal();
            } else {
                showError('Please select a rating before submitting.');
            }
        }

        // Debug function to check assignments
        async function debugAssignments() {
            try {
                console.group('üîç Debug Assignments');
                console.log('Current user:', currentUser);
                console.log('Local assignmentsMap:', Array.from(assignmentsMap.entries()));
                console.log('Rated requests:', Array.from(ratedRequests));
                console.log('Request status map:', Array.from(requestStatusMap.entries()));
                
                // Check all requests to see assignments
                const requests = await getAllRequests();
                const myAssignedRequests = requests.filter(req => 
                    req.helper_email === currentUser.email && req.status?.toLowerCase() === 'assigned'
                );
                console.log('My assigned requests:', myAssignedRequests);
                
                console.groupEnd();
                return myAssignedRequests;
            } catch (error) {
                console.error('Debug failed:', error);
                return [];
            }
        }

        // Refresh current user data
        async function refreshCurrentUser() {
            if (currentUser.id && currentUser.email !== 'guest@example.com') {
                try {
                    const updatedUser = await getStudentById(currentUser.id);
                    if (updatedUser) {
                        currentUser = { ...currentUser, ...updatedUser };
                        updateUserUI();
                    }
                } catch (error) {
                    console.error('Error refreshing user data:', error);
                }
            }
        }

        // Filter requests
        function filterRequests(status) {
            const requests = document.querySelectorAll('.request-item');
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            filterBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            requests.forEach(request => {
                const requestStatus = request.getAttribute('data-status');
                if (status === 'all' || requestStatus === status) {
                    request.style.display = 'block';
                } else {
                    request.style.display = 'none';
                }
            });
        }
        function getRequestActionButton(request, status, isMyRequest, isAssignedToMe, isRated) {
            console.log(`üîß Creating action button for request ${request.id}:`, {
                status: status,
                isMyRequest: isMyRequest,
                isAssignedToMe: isAssignedToMe,
                isRated: isRated,
                currentUser: currentUser.email,
                helper: request.helper_email
            });

            // If request is already completed
            if (status === 'closed' || isRated) {
                if (isRated) {
                    return `<span class="text-xs text-green-600 font-medium">‚úì Rated</span>`;
                }
                return `<span class="text-xs text-gray-500">Completed</span>`;
            }

            // If it's my own request (requester view)
            if (isMyRequest) {
                if (status === 'open') {
                    return `<span class="text-xs text-gray-500">Waiting for helper...</span>`;
                } else if (status === 'assigned') {
                    return `
                        <div class="flex flex-col space-y-2">
                            <span class="text-xs text-gray-500">Being helped by ${request.helper_name || request.helper_email || 'someone'}</span>
                            
                            <button onclick="requesterEndSessionAndRate(${request.id}, ${request.assignment_id})" class="px-3 py-1 bg-green-600 text-white rounded-lg text-xs font-medium hover:shadow-lg transition-all">
                                End Session & Rate Helper
                            </button>

                        </div>
                    `;
                }
            } 
            // If it's not my request (helper view)
            else {
                if (status === 'open') {
                    return `<button onclick="acceptRequest(${request.id})" class="px-4 py-2 tech-badge text-white rounded-lg text-sm font-medium hover:shadow-lg transition-all">Accept Request</button>`;
                } else if (status === 'assigned' && isAssignedToMe) {
                    // Helper view - waiting for requester to rate
                    return `
                        <div class="flex flex-col space-y-2">
                            <span class="text-xs text-green-600 font-medium">You are helping</span>
                            <span class="text-xs text-gray-500">Waiting for requester to complete session</span>
                        </div>
                    `;
                } else if (status === 'assigned') {
                    return `<span class="text-xs text-gray-500">Already assigned to ${request.helper_name || request.helper_email || 'someone'}</span>`;
                }
            }
            
            // Default fallback
            return `<span class="text-xs text-gray-500">Completed</span>`;
        }

        function getStarRating(rating) {
            if (!rating) return '';
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += i <= rating ? '‚òÖ' : '‚òÜ';
            }
            return stars;
        }

        // USER MANAGEMENT FUNCTIONS

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('hidden');
        }

        function switchAccount() {
            userManagementMode = 'switch';
            document.getElementById('userManagementTitle').textContent = 'Switch Account';
            document.getElementById('userManagementAction').textContent = 'Switch';
            
            const content = document.getElementById('userManagementContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Account</label>
                        <select id="accountSelect" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                            <option value="">Select a user...</option>
                        </select>
                    </div>
                </div>
            `;
            
            loadUsersForSwitch();
            
            document.getElementById('userMenu').classList.add('hidden');
            document.getElementById('userManagementModal').classList.remove('hidden');
            document.getElementById('userManagementModal').classList.add('flex');
        }

        async function loadUsersForSwitch() {
            try {
                const select = document.getElementById('accountSelect');
                
                select.innerHTML = '<option value="">Select a user...</option>';
                
                if (availableUsers.length === 0) {
                    select.innerHTML += '<option value="">No users found. Please register first.</option>';
                } else {
                    availableUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} (${user.email})`;
                        if (user.id === currentUser.id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users for switch:', error);
                const select = document.getElementById('accountSelect');
                select.innerHTML = '<option value="">Error loading users</option>';
            }
        }

        function processUserManagement() {
            if (userManagementMode === 'switch') {
                const accountSelect = document.getElementById('accountSelect');
                const selectedValue = accountSelect.value;
                
                if (!selectedValue) {
                    showError('Please select an account');
                    return;
                }
                
                const selectedText = accountSelect.options[accountSelect.selectedIndex].text;
                const [name, emailPart] = selectedText.split(' (');
                const email = emailPart.replace(')', '');
                
                const selectedUser = availableUsers.find(user => user.id == selectedValue);
                
                if (selectedUser) {
                    currentUser = selectedUser;
                    updateUserUI();
                    closeUserManagementModal();
                    showSuccess(`Switched to ${currentUser.name}`);
                    
                    initializeApp();
                } else {
                    showError('Selected user not found');
                }
            }
        }

        function closeUserManagementModal() {
            document.getElementById('userManagementModal').classList.add('hidden');
            document.getElementById('userManagementModal').classList.remove('flex');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = {
                    id: null,
                    name: "Guest User",
                    email: "guest@example.com",
                    rating_avg: 0,
                    dept: "Guest"
                };
                updateUserUI();
                showSuccess('Logged out successfully');
                document.getElementById('userMenu').classList.add('hidden');
                initializeApp();
            }
        }

        // RATING FUNCTIONS

        async function openRatingModal() {
            currentRating = 0;
            const stars = document.querySelectorAll('#ratingStarsInput span');
            stars.forEach(star => {
                star.textContent = '‚òÜ';
                star.style.color = '#6B7280';
            });
            document.getElementById('ratingComment').value = '';
            
            // Reset rating preview
            const ratingPreview = document.getElementById('ratingPreview');
            const ratingTargetInfo = document.getElementById('ratingTargetInfo');
            ratingPreview.classList.add('hidden');
            
            // Set the correct rating context - always rating the helper
            try {
                if (currentRequestToRate) {
                    const requests = await getAllRequests();
                    const currentRequest = requests.find(req => req.id === currentRequestToRate.requestId);
                    
                    if (currentRequest) {
                        const helperName = currentRequest.helper_name || currentRequest.helper_email || 'your helper';
                        ratingTargetInfo.textContent = `How was your session with ${helperName}?`;
                    }
                }
            } catch (error) {
                console.error('Error loading rating target info:', error);
                ratingTargetInfo.textContent = 'How was your session with the helper?';
            }
            
            document.getElementById('ratingModal').classList.remove('hidden');
            document.getElementById('ratingModal').classList.add('flex');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.add('hidden');
            document.getElementById('ratingModal').classList.remove('flex');
            currentRequestToRate = null;
        }

        function initializeRatingStars() {
            const stars = document.querySelectorAll('#ratingStarsInput span');
            const ratingPreview = document.getElementById('ratingPreview');
            const selectedRatingText = document.getElementById('selectedRatingText');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    currentRating = parseInt(this.getAttribute('data-rating'));
                    updateRatingStarsDisplay(currentRating);
                    
                    // Show rating preview
                    ratingPreview.classList.remove('hidden');
                    selectedRatingText.textContent = `${currentRating} star${currentRating > 1 ? 's' : ''} selected`;
                });
                
                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    updateRatingStarsDisplay(hoverRating, false);
                });
            });
            
            document.getElementById('ratingStarsInput').addEventListener('mouseleave', function() {
                updateRatingStarsDisplay(currentRating, true);
            });
        }

        function updateRatingStarsDisplay(rating, isPermanent = false) {
            const stars = document.querySelectorAll('#ratingStarsInput span');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '‚òÖ';
                    star.style.color = '#FF9013';
                } else {
                    star.textContent = '‚òÜ';
                    star.style.color = '#6B7280';
                }
            });
            
            if (isPermanent) {
                currentRating = rating;
            }
        }

        // UTILITY FUNCTIONS 

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        function formatDate(dateString) {
            if (!dateString) {
                return 'Today';
            }
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (isNaN(date.getTime())) {
                    return 'Today';
                }
                
                if (diffDays === 1) {
                    return 'Today';
                } else if (diffDays === 2) {
                    return 'Yesterday';
                } else if (diffDays <= 7) {
                    return `${diffDays - 1} days ago`;
                } else {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                return 'Today';
            }
        }

        function updateRatingStars(rating) {
            const starsContainer = document.getElementById('ratingStars');
            if (!starsContainer) return;
            
            const fullStars = Math.floor(rating);
            let starsHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                starsHTML += i <= fullStars ? '‚òÖ' : '‚òÜ';
            }
            
            starsContainer.innerHTML = starsHTML;
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toastContainer.contains(toast)) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showInfo(message) {
            showToast(message, 'info');
        }
    </script>
</body>
</html>
